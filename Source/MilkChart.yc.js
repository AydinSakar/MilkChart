// Copyright (C) 2012 Brett Dixon

// Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the 
// "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject 
// to the following conditions:

// The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO 
// THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT 
// SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN 
// ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE 
// USE OR OTHER DEALINGS IN THE SOFTWARE.

/*
---
description: Graphing/chart tool for MooTools

license: MIT License

authors:
- Brett Dixon

requires: 
- core/1.3.1: *
- more/1.3.2: Color

provides: [MilkChart.Column, MilkChart.Bar, MilkChart.Line, MilkChart.Scatter, MilkChart.Pie, MilkChart.Doughnut]


...
*/
(function(a){var b=a.MilkChart={};b.Colors=["#4f81bd","#c0504d","#9bbb59","#8064a2","#4198af","#db843d"];var c=new Class({initialize:function(a,b){this.x=a||0;this.y=b||0}});b.Base=new Class({Implements:[Options,Events],options:{width:480,height:290,colors:b.Colors,padding:12,font:"Verdana",fontColor:"#000000",fontSize:10,background:"#FFFFFF",chartLineColor:"#878787",chartLineWeight:1,border:true,borderWeight:1,borderColor:"#878787",titleSize:18,titleFont:"Verdana",titleColor:"#000000",showRowNames:true,showValues:true,showKey:true,useZero:true,copy:false,rowPrefix:"",ignoreFirstColumn:false},initialize:function(a,d){this.setOptions(d);this.element=document.id(a);this.width=this.options.width;this.height=this.options.height;this.container=this.element.get("tag")=="table"?(new Element("div")).inject(this.element.getParent()):this.element;this.container.setStyles({width:this.width,height:this.height,display:"inline-block"});this._canvas=(new Element("canvas",{width:this.options.width,height:this.options.height})).inject(this.container);this.ctx=this._canvas.getContext("2d");this.data={title:this.element.title,colNames:[],rowNames:[],rows:[]};this.minY=this.options.useZero?0:1e10;this.maxY=0;this.bounds=[new c,new c(this.width,this.height)];this.chartWidth=0;this.chartHeight=0;var e=.2;var f=.1;this.keyPadding=this.width*e;this.rowPadding=this.height*f;this.rowPaddingDimension="width";this.shapes=[];Object.each(b.Shapes,function(a){this.shapes.push(a)},this)},prepareCanvas:function(){if(!this.options.copy&&this.element.get("tag")=="table"){this.element.setStyle("display","none")}this.ctx.fillStyle=this.options.background;this.ctx.fillRect(0,0,this.width,this.height);this.ctx.font=this.options.fontSize+"px "+this.options.font;if(this.options.border){var a=.5;this.ctx.lineWeight=this.options.borderWeight;this.ctx.strokeRect(a,a,this.width-1,this.height-1)}if(this.options.showValues){this.bounds[0].x+=this.getValueColumnWidth()}this.bounds[0].x+=this.options.padding;this.bounds[0].y+=this.options.padding;this.bounds[1].x-=this.options.padding*2;this.bounds[1].y-=this.options.padding*2;if(this.options.showKey){var b="";this.data.colNames.each(function(a){if(a.length>b.length){b=String(a)}});var d=14;this.keyPadding=this.ctx.measureText(b).width+d;this.bounds[1].x-=this.keyPadding;var e=1.02;this.keyBounds=[new c(this.bounds[1].x*e,this.bounds[0].y),new c(this.keyPadding,this.bounds[1].y)]}this.chartWidth=this.bounds[1].x-this.bounds[0].x;if(this.data.title){var f=this.bounds[0].y+this.height*.1;this.bounds[0].y=f;this.titleBounds=[new c(this.bounds[0].x,0),new c(this.bounds[1].x,f)];this.drawTitle()}if(this.options.showRowNames){this.ctx.font=this.options.fontSize+"px "+this.options.font;this.getRowPadding();this.bounds[1].y-=this.rowPadding}else{this.rowPadding=0}this.chartHeight=this.bounds[1].y-this.bounds[0].y;this.colors=this.__getColors(this.options.colors)},getValueColumnWidth:function(){return this.ctx.measureText(String(this.maxY)).width},getRowPadding:function(){var a=0;this.data.rowNames.each(function(b){a+=this.ctx.measureText(b).width},this);var b=a>this.chartWidth;if(b){this.rowPadding=this.ctx.measureText(this.longestRowName).width}else{this.rowPadding=this.ctx.measureText(this.longestRowName).width>(this.bounds[1].x-this.bounds[0].x)/this.data.rows.length?this.ctx.measureText(this.longestRowName).width:this.height*.1}},drawTitle:function(){var a=1.25;var b=this.options.titleSize*a;this.ctx.textAlign="center";this.ctx.font=this.options.titleSize+"px "+this.options.titleFont;this.ctx.fillStyle=this.options.titleColor;this.ctx.fillText(this.data.title,this.bounds[0].x+(this.bounds[1].x-this.bounds[0].x)/2,b,this.chartWidth)},drawAxes:function(){this.ctx.beginPath();this.ctx.strokeStyle=this.options.chartLineColor;this.ctx.moveTo(this.bounds[0].x+.5,this.bounds[0].y+.5);this.ctx.lineTo(this.bounds[0].x+.5,this.bounds[1].y+.5);this.ctx.moveTo(this.bounds[0].x+.5,this.bounds[1].y+.5);this.ctx.lineTo(this.bounds[1].x+.5,this.bounds[1].y+.5);this.ctx.stroke()},drawValueLines:function(){var a=[1,2,5,10,20,50,100,150,500,1e3,1500,2e3,2500,5e3,1e4];var b=9;var c=0;this.chartLines=1;var d=Math.floor(this.maxY-this.minY);while(Math.floor(d/a[c])>b){c++}this.chartLines=Math.floor(d/a[c])+2;var e=a[c];var f=this.minY<0?e+this.minY:0;this.ratio=this.chartHeight/((this.chartLines-1)*e);this.ctx.font=this.options.fontSize+"px "+this.options.font;this.ctx.textAlign="right";this.ctx.fillStyle=this.options.fontColor;var g=this.bounds[1].y-this.bounds[0].y;var h=Math.floor(g/(this.chartLines-1));for(c=0;c<this.chartLines;c++){this.ctx.fillStyle=this.options.fontColor;var i=this.bounds[1].y-c*h;var j=Math.round(this.chartLines*e-(this.chartLines-c)*e+this.minY-f);this.ctx.beginPath();i+=.5;this.ctx.moveTo(this.bounds[0].x-4,i);if(this.options.showValues){var k=8;var l=3;this.ctx.fillText(String(j),this.bounds[0].x-k,i+l)}this.ctx.lineTo(this.bounds[1].x,i);this.ctx.stroke()}},swapAxes:function(){var a=this.data.rowNames.slice(0);var b=this.data.colNames.slice(0);this.data.rowNames=b;this.data.colNames=a;var c=[];this.data.rows.each(function(a,b){a.each(function(a,d){if(!c[d]){c[d]=[]}c[d][b]=a})});this.data.rows=c;this.setData(this.data);this.render()},setData:function(a){this.bounds=[new c,new c(this.width,this.height)];this.colors=this.__getColors(this.options.colors);this.minY=this.options.useZero?0:1e10;this.maxY=0;a.rows.each(function(a){var b=Math.max.apply(Math,a);var c=Math.min.apply(Math,a);this.maxY=b>this.maxY?b:this.maxY;this.minY=c<this.minY?c:this.minY},this);var b="";a.rowNames.each(function(a){if(this.ctx.measureText(a).width>this.ctx.measureText(b).width){b=String(a)}},this);this.longestRowName=b;this.data=a},load:function(a){var b=this;a=a||{};var c={method:"get",onSuccess:function(a){b.setData(a);b.render()}};var d=Object.merge(a,c);var e=new Request.JSON(d);e.send();return e},getData:function(){return null},draw:function(){return null},drawKey:function(){return null},__getColors:function(a){var b=[];if(a.length==1||a.length==2){var c=new Color(a[0]);var d=a.length==2?new Color(a[1]):(new Color("#ffffff")).mix(a[0],20);var e=[(d[0]-c[0])/this.data.colNames.length,(d[1]-c[1])/this.data.colNames.length,(d[2]-c[2])/this.data.colNames.length];var f=c;for(var g=0;g<this.data.colNames.length;g++){b.push(f.rgbToHex());for(var h=0;h<e.length;h++){f[h]+=parseInt(e[h])}}}else{var i=0;var j=a.slice(0);while(b.length!=this.data.colNames.length){if(j.length===0){j=a.slice(0);i+=20}var k=(new Color(j.shift())).mix("#ffffff",i);b.push(k.rgbToHex())}}return b}});b.Column=new Class({Extends:b.Base,options:{columnBorder:false,columnBorderWeight:2,columnBorderColor:"#ffffff"},initialize:function(a,b){this.parent(a,b);if(this.element.get("tag")=="table"){this.getData();this.render()}},render:function(){this.ctx.save();this.prepareCanvas();this.rowWidth=this.chartWidth/this.data.rows.length;this.drawAxes();this.drawValueLines();this.draw();if(this.options.showKey)this.drawKey();this.ctx.restore()},getData:function(){this.element.getElement("thead").getChildren()[0].getChildren().each(function(a){this.data.colNames.push(a.get("html"))}.bind(this));var a="";if(this.element.getElement("tfoot")){this.element.getElement("tfoot").getChildren()[0].getChildren().each(function(b){var c=b.get("html");this.data.rowNames.push(c);if(this.ctx.measureText(c).width>this.ctx.measureText(a).width){a=String(c)}}.bind(this))}this.element.getElement("tbody").getChildren().each(function(a){var b=[];a.getChildren().each(function(a){var c=Number(a.get("html"));if(!typeOf(c)){c=a.get("html").toFloat()}b.push(c);if(c>this.maxY)this.maxY=c;if(c<this.minY)this.minY=c}.bind(this));this.data.rows.push(b)}.bind(this));if(!this.element.getElement("tfoot")){for(var b=1;b<=this.data.rows.length;b++){var c=this.options.rowPrefix+b;this.data.rowNames.push(c);if(this.ctx.measureText(c).width>a.length){a=String(c)}}}this.longestRowName=a},draw:function(){var a=this.minY>=0?this.bounds[1].y:this.bounds[1].y-Math.floor(this.chartHeight/(this.chartLines-1));var d=new c(this.bounds[0].x,a);var e=Math.floor(this.rowWidth*.16);var f=Math.ceil((this.rowWidth-e*2)/this.data.rows[0].length);var g=this.ctx.measureText(this.longestRowName).width>this.rowWidth;var h=this.data.rows.length*this.options.fontSize/this.chartWidth/2;this.data.rows.each(function(a,i){var j=new c(d.x,d.y);this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="center";if(this.options.showRowNames){var k=b.escape(this.data.rowNames[i]);if(g){this.ctx.save();this.ctx.textAlign="right";this.ctx.translate(j.x+this.rowWidth/2+this.options.fontSize,this.bounds[1].y+4);this.ctx.rotate(-1.57079633);if(this.data.rows.length*this.options.fontSize>this.chartWidth){if(i%h==1){this.ctx.fillText(k,0,0)}}else{this.ctx.fillText(k,0,0)}this.ctx.restore()}else{this.ctx.fillText(k,j.x+this.rowWidth/2,this.bounds[1].y+this.rowPadding/2)}}a.each(function(a,b){this.ctx.beginPath();this.ctx.fillStyle=this.colors[b%this.colors.length];var c=Math.ceil(a*this.ratio)-1;this.ctx.fillStyle=this.colors[b];this.ctx.fillRect(j.x+e,j.y-c,f,c);if(this.options.columnBorder){this.ctx.strokeStyle=this.options.columnBorderColor;this.ctx.lineWidth=this.options.columnBorderWeight;this.ctx.strokeRect(j.x+e,j.y-c,f,c)}j.x+=f}.bind(this));d.x+=this.rowWidth}.bind(this))},drawKey:function(){var a=14;var c=.06;var d=Math.ceil(this.height*c);var e=this.data.colNames.length*d;var f=(this.height-e)/2;var g=10;this.data.colNames.each(function(c,e){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";c=b.escape(c);this.ctx.fillText(c,this.keyBounds[0].x+a,f+8);this.ctx.fillStyle=this.colors[e%this.colors.length];this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(f),g,g);f+=d},this)}});b.Bar=new Class({Extends:b.Column,options:{},initialize:function(a,b){this.parent(a,b)},getValueColumnWidth:function(){var a=14;return this.ctx.measureText(this.longestRowName).width+a},getRowPadding:function(){this.rowPadding=this.height*.1},drawValueLines:function(){var a=[1,2,5,10,20,50,100,150,500,1e3,1500,2e3,2500,5e3,1e4];var c=9;var d=0;this.chartLines=1;var e=Math.floor(this.maxY-this.minY);while(Math.floor(e/a[d])>c){d++}this.chartLines=Math.floor(e/a[d])+2;var f=a[d];this.ratio=this.chartWidth/((this.chartLines-1)*f);this.ctx.font=this.options.fontSize+"px "+this.options.font;this.ctx.textAlign="center";this.ctx.fillStyle=this.options.fontColor;var g=Math.ceil(this.chartWidth/(this.chartLines-1));for(d=0;d<this.chartLines;d++){this.ctx.fillStyle=this.options.fontColor;var h=this.bounds[0].x+d*g;var i=this.chartLines*f-(this.chartLines-d)*f+this.minY;this.ctx.beginPath();h=Math.round(h)+.5;this.ctx.moveTo(h,this.bounds[0].y);this.ctx.fillText(b.escape(i),h,this.bounds[1].y+14);this.ctx.lineTo(h,this.bounds[1].y+4);this.ctx.stroke()}},draw:function(){var a=new c(this.bounds[0].x,this.bounds[1].y);this.colHeight=Math.round(this.chartHeight/this.data.rows.length);var d=.16;var e=Math.ceil(this.colHeight*d);var f=Math.ceil((this.colHeight-e*2)/this.data.rows[0].length);var g=0;this.data.rows.each(function(d,h){var i=new c(a.x,a.y);var j=0;this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="center";var k=Math.ceil(this.ctx.measureText(this.data.rowNames[g]).width);if(this.options.showRowNames){var l=b.escape(this.data.rowNames[g]);if(this.data.rows.length*this.options.fontSize>this.chartWidth){if(h%8==1){this.ctx.fillText(l,i.x-(f+k)/2,i.y-this.rowPadding/2)}}else{this.ctx.fillText(l,i.x-(f+k)/2,i.y-this.rowPadding/2)}}d.each(function(a){this.ctx.beginPath();this.ctx.fillStyle=this.colors[j];var b=Math.ceil(a*this.ratio);this.ctx.fillRect(i.x,i.y-e,b,f);i.y-=f;j++}.bind(this));a.y-=this.colHeight;g++}.bind(this))}});b.Line=new Class({Extends:b.Column,options:{showTicks:false,showLines:true,tickSize:10,lineWeight:3},load:function(a){var b=this;a=a||{};var c={noCache:true,onSuccess:function(a){var c=[];a.rows.each(function(a,b){a.each(function(a,d){if(!c[d]){c[d]=[]}c[d][b]=a})});a.rows=c;b.setData(a);b.render()},onError:function(){}};var d=Object.merge(a,c);var e=new Request.JSON(d);e.send()},render:function(){this.ctx.save();this.prepareCanvas();this.rowWidth=this.chartWidth/this.data.rows[0].length;this.drawAxes();this.drawValueLines();this.draw();if(this.options.showKey)this.drawKey();this.ctx.restore()},getData:function(){this.data.rows=[];this.element.getElement("thead").getChildren()[0].getChildren().each(function(a){this.data.colNames.push(a.get("html"));this.data.rows.push([])}.bind(this));var a="";if(this.element.getElement("tfoot")){this.element.getElement("tfoot").getChildren()[0].getChildren().each(function(b){var c=b.get("html");this.data.rowNames.push(c);if(this.ctx.measureText(c).width>a.length){a=String(c)}}.bind(this))}this.element.getElement("tbody").getChildren().each(function(a){a.getChildren().each(function(a,b){var c=Number(a.get("html"));if(!typeOf(c)){c=a.get("html").toFloat()}this.data.rows[b].push(c);if(c>this.maxY)this.maxY=c;if(c<this.minY)this.minY=c}.bind(this))}.bind(this));if(!this.element.getElement("tfoot")){for(var b=1;b<=this.element.getElement("tbody").getChildren().length;b++){var c=this.options.rowPrefix+b;this.data.rowNames.push(c);if(this.ctx.measureText(c).width>a.length){a=String(c)}}}this.longestRowName=a},draw:function(){var a=new c(this.bounds[0].x,this.bounds[1].y);var d=this.rowWidth/2;var e=0;var f=0;var g=this.minY>=0?this.bounds[1].y+this.minY*this.ratio:this.bounds[1].y-Math.floor(this.chartHeight/(this.chartLines-1));var h=0;this.data.rows.each(function(i,j){var k;if(this.options.showLines){k=new c(a.x,a.y);this.ctx.lineWidth=this.options.lineWeight;this.ctx.beginPath();this.ctx.strokeStyle=this.colors[j];this.ctx.moveTo(k.x+d,g-i[0]*this.ratio);i.each(function(a){var b=k.x+d;var e=new c(b,g-a*this.ratio);this.ctx.lineTo(e.x,e.y);k.x+=this.rowWidth}.bind(this));this.ctx.stroke()}if(this.options.showTicks){k=new c(a.x,a.y);h=h>b.Shapes.getLength()-1?0:h;var l=this.shapes[h];i.each(function(a){var b=k.x+d;var e=new c(b,g-a*this.ratio);l(this.ctx,e.x,e.y,this.options.tickSize,this.colors[j]);k.x+=this.rowWidth}.bind(this));h++}f++;e++}.bind(this));this.__drawRowLabels()},drawKey:function(){var a=Math.ceil(this.height*.05);var c=this.data.colNames.length*a;var d=(this.height-c)/2;var e=0;this.data.colNames.each(function(c,f){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";this.ctx.fillText(b.escape(c),this.keyBounds[0].x+30,d+5);this.ctx.fillStyle=this.colors[f%this.colors.length];this.ctx.strokeStyle=this.colors[f%this.colors.length];this.ctx.lineWidth=3;if(this.options.showLines){this.ctx.beginPath();this.ctx.moveTo(this.keyBounds[0].x,d+.5);this.ctx.lineTo(this.keyBounds[0].x+20,d+.5);this.ctx.closePath();this.ctx.stroke()}if(this.options.showTicks){e=e>b.Shapes.getLength()-1?0:e;var g=this.shapes[e];g(this.ctx,this.keyBounds[0].x+10,d,10,this.colors[f%this.colors.length]);e++}d+=a}.bind(this))},__drawRowLabels:function(){var a=new c(this.bounds[0].x,this.bounds[1].y);var d=this.ctx.measureText(this.longestRowName).width>this.rowWidth;var e=Math.floor(this.data.rowNames.length*this.options.fontSize/(this.chartWidth/2));this.ctx.fillStyle=this.options.fontColor;this.ctx.lineWidth=1;this.ctx.textAlign="center";this.data.rowNames.each(function(c,f){var g=b.escape(this.data.rowNames[f]);if(d){this.ctx.save();this.ctx.textAlign="right";this.ctx.translate(a.x+this.rowWidth/2+this.options.fontSize,this.bounds[1].y+4);this.ctx.rotate(-1.57079633);if(this.data.rowNames.length*this.options.fontSize>this.chartWidth){if(f%e==1){this.ctx.fillText(g,0,0)}}else{this.ctx.fillText(g,0,0)}this.ctx.restore()}else{this.ctx.fillText(g,a.x+this.rowWidth/2,this.bounds[1].y+this.rowPadding/2)}a.x+=this.rowWidth}.bind(this))}});b.Scatter=new Class({Extends:b.Line,options:{showTicks:true,showLines:false},initialize:function(a,b){this.parent(a,b)}});b.Pie=new Class({Extends:b.Base,options:{stroke:true,strokeWeight:3,strokeColor:"#ffffff",chartTextColor:"#000000",shadow:false,chartLineWeight:2,pieBorder:false},initialize:function(a,b){this.parent(a,b);if(this.element.get("tag")=="table"){this.rowCount=this.element.getElement("thead").getChildren()[0].getChildren().length;this.colors=this.__getColors(this.options.colors);this.options.showRowNames=false;this.getData();this.render()}},swapAxes:function(){return true},render:function(){this.ctx.save();this.prepareCanvas();this.radius=this.chartHeight/2;if(this.options.showKey)this.drawKey();this.draw();this.ctx.restore()},setData:function(a){this.bounds=[new c,new c(this.width,this.height)];this.colors=this.__getColors(this.options.colors);a.rowNames=a.colNames;var b="";a.rowNames.each(function(a){if(this.ctx.measureText(a).width>this.ctx.measureText(b).width){b=String(a)}},this);this.longestRowName=b;var d=[];var e=0;a.rows.each(function(a){e+=a[0]});a.rows.each(function(a,b){var c=[a[0],a[0]/e*360];d.push(c)},this);this.pieTotal=e;a.rows=d;this.data=a},getData:function(){this.element.getElement("thead").getChildren()[0].getChildren().each(function(a){this.data.rowNames.push(a.get("html"));this.data.colNames.push(a.get("html"))}.bind(this));var a=0;this.element.getElement("tbody").getChildren()[0].getChildren().each(function(b){var c=[];var d=b.get("html").toInt();c.push(d);a+=d;this.data.rows.push(c)}.bind(this));this.data.rows.each(function(b){b.push(b[0]/a*360)});this.pieTotal=a},draw:function(){var a=0;var b=new c(this.bounds[1].x/2+this.options.padding,this.bounds[1].y/2+this.options.padding);if(this.options.shadow){var d=this.ctx.createRadialGradient(b.x,b.y,this.radius,b.x*1.03,b.y*1.03,this.radius*1.05);d.addColorStop(.5,"#000000");d.addColorStop(.75,"#000000");d.addColorStop(1,"rgba(0,0,0,0)");this.ctx.fillStyle=d;this.ctx.fillRect(this.bounds[0].x,this.bounds[0].y,this.width,this.height)}this.data.rows.each(function(c,d){this.ctx.fillStyle=this.colors[d%this.colors.length];this.ctx.beginPath();this.ctx.arc(b.x,b.y,this.radius,Math.PI/180*a,Math.PI/180*(c[1]+a),false);this.ctx.lineTo(b.x,b.y);this.ctx.closePath();this.ctx.fill();if(this.options.stroke){this.ctx.strokeStyle=this.options.strokeColor;this.ctx.lineWidth=this.options.strokeWeight;this.ctx.lineJoin="round";this.ctx.beginPath();this.ctx.arc(b.x,b.y,this.radius,Math.PI/180*a,Math.PI/180*(c[1]+a),false);this.ctx.lineTo(b.x,b.y);this.ctx.closePath();this.ctx.stroke()}if(this.options.showValues){this.ctx.font=this.options.fontSize+"px "+this.options.font;this.ctx.fillStyle=this.options.chartTextColor;this.ctx.textAlign="center";var e=Math.PI/180*a;var f=Math.PI/180*(c[1]+a);var g=e+(f-e)/2;var h=Math.round(c[0]/this.pieTotal*100);var i=h<5?.9:1.75;var j=this.radius*Math.cos(g)/i;var k=this.radius*Math.sin(g)/i;this.ctx.fillText(h+"%",b.x+j,b.y+k)}a+=c[1]}.bind(this));if(this.options.pieBorder){this.ctx.lineWidth=this.options.chartLineWeight;this.ctx.strokeStyle=this.options.chartLineColor;this.ctx.beginPath();this.ctx.arc(b.x,b.y,this.radius-1,0,Math.PI*2);this.ctx.stroke()}},drawKey:function(){var a=Math.ceil(this.height*.06);var c=this.data.rowNames.length*a;c=c>this.height?this.height*.9:c;var d=(this.height-c)/2;this.ctx.font=this.options.fontSize+"px "+this.options.font;this.data.rowNames.each(function(c,e){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";this.ctx.fillText(b.escape(c),this.keyBounds[0].x+14,d+8);this.ctx.fillStyle=this.colors[e%this.colors.length];this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(d),10,10);d+=a}.bind(this))}});b.Doughnut=new Class({Extends:b.Base,options:{stroke:true,strokeWeight:1,strokeColor:"#ffffff",chartTextColor:"#000000",shadow:false,chartLineWeight:2,pieBorder:false},initialize:function(a,b){this.parent(a,b);if(this.element.get("tag")=="table"){this.getData();this.rowCount=this.element.getElements("th").length;this.colors=this.__getColors(this.options.colors);this.options.showRowNames=false;this.render()}},swapAxes1:function(){return true},render:function(){this.ctx.save();this.prepareCanvas();this.radius=this.chartHeight/2;if(this.options.showKey)this.drawKey();this.draw();this.ctx.restore()},setData:function(a){this.bounds=[new c,new c(this.width,this.height)];this.colors=this.__getColors(this.options.colors);var b="";a.colNames.each(function(a){if(this.ctx.measureText(a).width>this.ctx.measureText(b).width){b=String(a)}},this);this.longestRowName=b;var d=[];a.totals=[];a.rows.each(function(b,c){var e=0;b.each(function(a){e+=typeof a=="number"?a:a[0]});var f=[];b.each(function(a){var b=typeof a=="number"?a:a[0];f.push([b,b/e*360])});d.push(f);a.totals.push(e)});a.rows=d;this.data=a},getData:function(){this.element.getElements("th").each(function(a){this.data.colNames.push(a.get("html"))}.bind(this));var a=this.element.getElements("tbody tr");if(this.element.tfoot){this.element.getElement("tfoot").getChildren().getChildren().each(function(a){this.data.rowNames.push(a.get("html"))}.bind(this))}else{a.each(function(a,b){this.data.rowNames.push(this.options.rowPrefix+b)},this)}this.data.totals=[];a.each(function(a,b){var c=0;a.getElements("td").each(function(a){c+=a.get("html").toInt()});var d=[];a.getElements("td").each(function(a){d.push([a.get("html").toInt(),a.get("html").toInt()/c*360])});this.data.rows.push(d);this.data.totals.push(c)},this)},draw:function(){var a=0;var b=new c(this.bounds[1].x/2+this.options.padding,this.bounds[1].y/2+this.options.padding);var d=this.radius/2/this.data.rows.length;var e=Number(this.radius);this.data.rows.each(function(c,f){c.each(function(c,d){this.ctx.fillStyle=this.colors[d%this.colors.length];this.ctx.beginPath();this.ctx.arc(b.x,b.y,e,Math.PI/180*a,Math.PI/180*(c[1]+a),false);this.ctx.lineTo(b.x,b.y);this.ctx.closePath();this.ctx.fill();if(this.options.stroke){this.ctx.strokeStyle=this.options.strokeColor;this.ctx.lineWidth=this.options.strokeWeight;this.ctx.beginPath();this.ctx.arc(b.x,b.y,e,Math.PI/180*a,Math.PI/180*(c[1]+a),false);this.ctx.lineTo(b.x,b.y);this.ctx.closePath();this.ctx.stroke()}a+=c[1]},this);e-=d;a=0},this);this.ctx.beginPath();this.ctx.fillStyle="#ffffff";this.ctx.arc(b.x,b.y,this.radius/2,0,Math.PI*2);this.ctx.fill()},drawKey:function(){var a=Math.ceil(this.height*.06);var c=this.data.rowNames.length*a;c=c>this.height?this.height*.9:c;var d=(this.height-c)/2;this.ctx.font=this.options.fontSize+"px "+this.options.font;this.data.colNames.each(function(c,e){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";this.ctx.fillText(b.escape(c),this.keyBounds[0].x+14,d+8);this.ctx.fillStyle=this.colors[e%this.colors.length];this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(d),10,10);d+=a}.bind(this))}});b.Shapes={square:function(a,b,c,d,e){a.fillStyle=e;a.fillRect(b-d/2,c-d/2,d,d)},circle:function(a,b,c,d,e){a.fillStyle=e;a.beginPath();a.arc(b,c,d/2,0,Math.PI/180*360,true);a.closePath();a.fill()},triangle:function(a,b,d,e,f){a.fillStyle=f;a.beginPath();b-=e/2;d-=e/2;var g=new c(b+e,d+e);a.moveTo(b,g.y);a.lineTo(b+e/2,d);a.lineTo(g.x,g.y);a.closePath();a.fill()},cross:function(a,b,c,d,e){b-=d/2;c-=d/2;a.strokeStyle=e;a.lineWidth=d/2;a.beginPath();a.moveTo(b,c);a.lineTo(b+d,c+d);a.moveTo(b,c+d);a.lineTo(b+d,c);a.closePath();a.stroke()},diamond:function(a,b,c,d,e){b-=d/2;c-=d/2;a.fillStyle=e;a.beginPath();a.moveTo(b+d/2,c);a.lineTo(b+d,c+d/2);a.lineTo(b+d/2,c+d);a.lineTo(b,c+d/2);a.closePath();a.fill()},pipe:function(a,b,c,d,e){c-=d/2;a.strokeStyle=e;a.lineWidth=d/2;a.beginPath();a.moveTo(b,c);a.lineTo(b,c+d);a.stroke()}};b.escape=function(a){a=String(a);var b=[[/\&/g,"&"],[/\</g,"<"],[/\>/g,">"]];b.each(function(b){a=a.replace(b[0],b[1])});return a}})(window)