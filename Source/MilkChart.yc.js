// Copyright (C) 2012 Brett Dixon

// Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the 
// "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject 
// to the following conditions:

// The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO 
// THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT 
// SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN 
// ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE 
// USE OR OTHER DEALINGS IN THE SOFTWARE.

/*
---
description: Graphing/chart tool for MooTools

license: MIT License

authors:
- Brett Dixon

requires: 
- core/1.3.1: *
- more/1.3.2: Color

provides: [MilkChart.Column, MilkChart.Bar, MilkChart.Line, MilkChart.Scatter, MilkChart.Pie, MilkChart.Doughnut]


...
*/

(function(b){var c=b.MilkChart={};c.Colors=["#4f81bd","#c0504d","#9bbb59","#8064a2","#4198af","#db843d"];var a=new Class({initialize:function(d,e){this.x=d||0;this.y=e||0}});c.Base=new Class({Implements:[Options,Events],options:{width:480,height:290,colors:c.Colors,padding:12,font:"Verdana",fontColor:"#000000",fontSize:10,background:"#FFFFFF",chartLineColor:"#878787",chartLineWeight:1,border:true,borderWeight:1,borderColor:"#878787",titleSize:18,titleFont:"Verdana",titleColor:"#000000",showRowNames:true,showValues:true,showKey:true,useZero:true,copy:false,rowPrefix:"",ignoreFirstColumn:false},initialize:function(f,e){this.setOptions(e);this.element=document.id(f);this.width=this.options.width;this.height=this.options.height;this.container=(this.element.get("tag")=="table")?new Element("div").inject(this.element.getParent()):this.element;this.container.setStyles({width:this.width,height:this.height,display:"inline-block"});this._canvas=new Element("canvas",{width:this.options.width,height:this.options.height}).inject(this.container);this.ctx=this._canvas.getContext("2d");this.data={title:this.element.title,colNames:[],rowNames:[],rows:[]};this.minY=(this.options.useZero)?0:10000000000;this.maxY=0;this.bounds=[new a(),new a(this.width,this.height)];this.chartWidth=0;this.chartHeight=0;var g=0.2;var d=0.1;this.keyPadding=this.width*g;this.rowPadding=this.height*d;this.rowPaddingDimension="width";this.shapes=[];Object.each(c.Shapes,function(h){this.shapes.push(h)},this)},prepareCanvas:function(){if(!this.options.copy&&this.element.get("tag")=="table"){this.element.setStyle("display","none")}this.ctx.fillStyle=this.options.background;this.ctx.fillRect(0,0,this.width,this.height);this.ctx.font=this.options.fontSize+"px "+this.options.font;if(this.options.border){var g=0.5;this.ctx.lineWeight=this.options.borderWeight;this.ctx.strokeRect(g,g,this.width-1,this.height-1)}if(this.options.showValues){this.bounds[0].x+=this.getValueColumnWidth()}this.bounds[0].x+=this.options.padding;this.bounds[0].y+=this.options.padding;this.bounds[1].x-=this.options.padding*2;this.bounds[1].y-=this.options.padding*2;if(this.options.showKey){var e="";this.data.colNames.each(function(i){if(i.length>e.length){e=String(i)}});var f=14;this.keyPadding=this.ctx.measureText(e).width+f;this.bounds[1].x-=this.keyPadding;var d=1.02;this.keyBounds=[new a(this.bounds[1].x*d,this.bounds[0].y),new a(this.keyPadding,this.bounds[1].y)]}this.chartWidth=this.bounds[1].x-this.bounds[0].x;if(this.data.title){var h=this.bounds[0].y+this.height*0.1;this.bounds[0].y=h;this.titleBounds=[new a(this.bounds[0].x,0),new a(this.bounds[1].x,h)];this.drawTitle()}if(this.options.showRowNames){this.ctx.font=this.options.fontSize+"px "+this.options.font;this.getRowPadding();this.bounds[1].y-=this.rowPadding}else{this.rowPadding=0}this.chartHeight=this.bounds[1].y-this.bounds[0].y;this.colors=this.__getColors(this.options.colors)},getValueColumnWidth:function(){return this.ctx.measureText(String(this.maxY)).width},getRowPadding:function(){var e=0;this.data.rowNames.each(function(f){e+=this.ctx.measureText(f).width},this);var d=(e>this.chartWidth);if(d){this.rowPadding=this.ctx.measureText(this.longestRowName).width}else{this.rowPadding=(this.ctx.measureText(this.longestRowName).width>((this.bounds[1].x-this.bounds[0].x)/this.data.rows.length))?this.ctx.measureText(this.longestRowName).width:this.height*0.1}},drawTitle:function(){var d=1.25;var e=this.options.titleSize*d;this.ctx.textAlign="center";this.ctx.font=this.options.titleSize+"px "+this.options.titleFont;this.ctx.fillStyle=this.options.titleColor;this.ctx.fillText(this.data.title,this.bounds[0].x+(this.bounds[1].x-this.bounds[0].x)/2,e,this.chartWidth)},drawAxes:function(){this.ctx.beginPath();this.ctx.strokeStyle=this.options.chartLineColor;this.ctx.moveTo(this.bounds[0].x+0.5,this.bounds[0].y+0.5);this.ctx.lineTo(this.bounds[0].x+0.5,this.bounds[1].y+0.5);this.ctx.moveTo(this.bounds[0].x+0.5,this.bounds[1].y+0.5);this.ctx.lineTo(this.bounds[1].x+0.5,this.bounds[1].y+0.5);this.ctx.stroke()},drawValueLines:function(){var m=[1,2,5,10,20,50,100,150,500,1000,1500,2000,2500,5000,10000];var e=m[m.length-1];while(this.maxY>e){e+=10000;m.push(e)}var n=9;var k=0;this.chartLines=1;var p=Math.floor((this.maxY-this.minY));while(Math.floor((p/m[k]))>n){k++}this.chartLines=Math.floor((p/m[k]))+2;var h=m[k];var g=(this.minY<0)?(h+this.minY):0;this.ratio=(this.chartHeight)/((this.chartLines-1)*h);this.ctx.font=this.options.fontSize+"px "+this.options.font;this.ctx.textAlign="right";this.ctx.fillStyle=this.options.fontColor;var q=this.bounds[1].y-this.bounds[0].y;var o=Math.floor(q/(this.chartLines-1));for(k=0;k<this.chartLines;k++){this.ctx.fillStyle=this.options.fontColor;var d=this.bounds[1].y-(k*o);var f=Math.round((this.chartLines*h)-((this.chartLines-k)*h)+this.minY-g);this.ctx.beginPath();d+=0.5;this.ctx.moveTo(this.bounds[0].x-4,d);if(this.options.showValues){var l=8;var j=3;this.ctx.fillText(String(f),this.bounds[0].x-l,d+j)}this.ctx.lineTo(this.bounds[1].x,d);this.ctx.stroke()}},swapAxes:function(){var f=this.data.rowNames.slice(0);var d=this.data.colNames.slice(0);this.data.rowNames=d;this.data.colNames=f;var e=[];this.data.rows.each(function(h,g){h.each(function(i,j){if(!e[j]){e[j]=[]}e[j][g]=i})});this.data.rows=e;this.setData(this.data);this.render()},setData:function(e){this.bounds=[new a(),new a(this.width,this.height)];this.colors=this.__getColors(this.options.colors);this.minY=(this.options.useZero)?0:10000000000;this.maxY=0;e.rows.each(function(g){var f=Math.max.apply(Math,g);var h=Math.min.apply(Math,g);this.maxY=(f>this.maxY)?f:this.maxY;this.minY=(h<this.minY)?h:this.minY},this);var d="";e.rowNames.each(function(f){if(this.ctx.measureText(f).width>this.ctx.measureText(d).width){d=String(f)}},this);this.longestRowName=d;this.data=e},load:function(f){var e=this;f=f||{};var g={method:"get",onSuccess:function(i){e.setData(i);e.render()}};var d=Object.merge(f,g);var h=new Request.JSON(d);h.send();return h},getData:function(){return null},draw:function(){return null},drawKey:function(){return null},__getColors:function(p){var d=[];if(p.length==1||p.length==2){var e=new Color(p[0]);var l=(p.length==2)?new Color(p[1]):new Color("#ffffff").mix(p[0],20);var n=[(l[0]-e[0])/this.data.colNames.length,(l[1]-e[1])/this.data.colNames.length,(l[2]-e[2])/this.data.colNames.length];var k=e;for(var g=0;g<this.data.colNames.length;g++){d.push(k.rgbToHex());for(var f=0;f<n.length;f++){k[f]+=parseInt(n[f])}}}else{var o=0;var m=p.slice(0);while(d.length!=this.data.colNames.length){if(m.length===0){m=p.slice(0);o+=20}var h=new Color(m.shift()).mix("#ffffff",o);d.push(h.rgbToHex())}}return d}});c.Column=new Class({Extends:c.Base,options:{columnBorder:false,columnBorderWeight:2,columnBorderColor:"#ffffff"},initialize:function(e,d){this.parent(e,d);if(this.element.get("tag")=="table"){this.getData();this.render()}},render:function(){this.ctx.save();this.prepareCanvas();this.rowWidth=this.chartWidth/this.data.rows.length;this.drawAxes();this.drawValueLines();this.draw();if(this.options.showKey){this.drawKey()}this.ctx.restore()},getData:function(){this.element.getElement("thead").getChildren()[0].getChildren().each(function(g){this.data.colNames.push(g.get("html"))}.bind(this));var d="";if(this.element.getElement("tfoot")){this.element.getElement("tfoot").getChildren()[0].getChildren().each(function(h){var g=h.get("html");this.data.rowNames.push(g);if(this.ctx.measureText(g).width>this.ctx.measureText(d).width){d=String(g)}}.bind(this))}this.element.getElement("tbody").getChildren().each(function(h){var g=[];h.getChildren().each(function(i){var j=Number(i.get("html"));if(!typeOf(j)){j=i.get("html").toFloat()}g.push(j);if(j>this.maxY){this.maxY=j}if(j<this.minY){this.minY=j}}.bind(this));this.data.rows.push(g)}.bind(this));if(!this.element.getElement("tfoot")){for(var f=1;f<=this.data.rows.length;f++){var e=this.options.rowPrefix+f;this.data.rowNames.push(e);if(this.ctx.measureText(e).width>d.length){d=String(e)}}}this.longestRowName=d},draw:function(){var i=(this.minY>=0)?this.bounds[1].y:this.bounds[1].y-Math.floor((this.chartHeight/(this.chartLines-1)));var e=new a(this.bounds[0].x,i);var d=Math.floor(this.rowWidth*0.16);var f=Math.ceil((this.rowWidth-(d*2))/this.data.rows[0].length);var g=(this.ctx.measureText(this.longestRowName).width>this.rowWidth);var h=((this.data.rows.length*this.options.fontSize)/this.chartWidth)/2;this.data.rows.each(function(m,j){var k=new a(e.x,e.y);this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="center";if(this.options.showRowNames){var l=c.escape(this.data.rowNames[j]);if(g){this.ctx.save();this.ctx.textAlign="right";this.ctx.translate(k.x+(this.rowWidth/2)+this.options.fontSize,this.bounds[1].y+4);this.ctx.rotate(-1.57079633);if(this.data.rows.length*this.options.fontSize>this.chartWidth){if(j%h==1){this.ctx.fillText(l,0,0)}}else{this.ctx.fillText(l,0,0)}this.ctx.restore()}else{this.ctx.fillText(l,k.x+(this.rowWidth/2),this.bounds[1].y+(this.rowPadding/2))}}m.each(function(o,p){this.ctx.beginPath();this.ctx.fillStyle=this.colors[p%this.colors.length];var n=Math.ceil(o*this.ratio)-1;this.ctx.fillStyle=this.colors[p];this.ctx.fillRect(k.x+d,k.y-n,f,n);if(this.options.columnBorder){this.ctx.strokeStyle=this.options.columnBorderColor;this.ctx.lineWidth=this.options.columnBorderWeight;this.ctx.strokeRect(k.x+d,k.y-n,f,n)}k.x+=f}.bind(this));e.x+=this.rowWidth}.bind(this))},drawKey:function(){var e=14;var i=0.06;var f=Math.ceil(this.height*i);var h=this.data.colNames.length*f;var d=(this.height-h)/2;var g=10;this.data.colNames.each(function(k,j){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";k=c.escape(k);this.ctx.fillText(k,this.keyBounds[0].x+e,d+8);this.ctx.fillStyle=this.colors[j%this.colors.length];this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(d),g,g);d+=f},this)}});c.Bar=new Class({Extends:c.Column,options:{},initialize:function(e,d){this.parent(e,d)},getValueColumnWidth:function(){var d=14;return this.ctx.measureText(this.longestRowName).width+d},getRowPadding:function(){this.rowPadding=this.height*0.1},drawValueLines:function(){var j=[1,2,5,10,20,50,100,150,500,1000,1500,2000,2500,5000,10000];var d=j[j.length-1];while(this.maxY>d){d+=10000;j.push(d)}var k=9;var h=0;this.chartLines=1;var m=Math.floor((this.maxY-this.minY));while(Math.floor((m/j[h]))>k){h++}this.chartLines=Math.floor((m/j[h]))+2;var g=j[h];this.ratio=(this.chartWidth)/((this.chartLines-1)*g);this.ctx.font=this.options.fontSize+"px "+this.options.font;this.ctx.textAlign="center";this.ctx.fillStyle=this.options.fontColor;var l=Math.ceil(this.chartWidth/(this.chartLines-1));for(h=0;h<this.chartLines;h++){this.ctx.fillStyle=this.options.fontColor;var e=this.bounds[0].x+(h*l);var f=(this.chartLines*g)-((this.chartLines-h)*g)+this.minY;this.ctx.beginPath();e=Math.round(e)+0.5;this.ctx.moveTo(e,this.bounds[0].y);this.ctx.fillText(c.escape(f),e,this.bounds[1].y+14);this.ctx.lineTo(e,this.bounds[1].y+4);this.ctx.stroke()}},draw:function(){var f=new a(this.bounds[0].x,this.bounds[1].y);this.colHeight=Math.round(this.chartHeight/this.data.rows.length);var h=0.16;var d=Math.ceil(this.colHeight*h);var g=Math.ceil((this.colHeight-(d*2))/this.data.rows[0].length);var e=0;this.data.rows.each(function(n,i){var k=new a(f.x,f.y);var j=0;this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="center";var m=Math.ceil(this.ctx.measureText(this.data.rowNames[e]).width);if(this.options.showRowNames){var l=c.escape(this.data.rowNames[e]);if(this.data.rows.length*this.options.fontSize>this.chartWidth){if(i%8==1){this.ctx.fillText(l,k.x-((g+m)/2),k.y-(this.rowPadding/2))}}else{this.ctx.fillText(l,k.x-((g+m)/2),k.y-(this.rowPadding/2))}}n.each(function(p){this.ctx.beginPath();this.ctx.fillStyle=this.colors[j];var o=Math.ceil(p*this.ratio);this.ctx.fillRect(k.x,k.y-d,o,g);k.y-=g;j++}.bind(this));f.y-=this.colHeight;e++}.bind(this))}});c.Line=new Class({Extends:c.Column,options:{showTicks:false,showLines:true,tickSize:10,lineWeight:3},load:function(f){var e=this;f=f||{};var g={noCache:true,onSuccess:function(j){var i=[];j.rows.each(function(l,k){l.each(function(m,n){if(!i[n]){i[n]=[]}i[n][k]=m})});j.rows=i;e.setData(j);e.render()},onError:function(){}};var d=Object.merge(f,g);var h=new Request.JSON(d);h.send()},render:function(){this.ctx.save();this.prepareCanvas();this.rowWidth=this.chartWidth/this.data.rows[0].length;this.drawAxes();this.drawValueLines();this.draw();if(this.options.showKey){this.drawKey()}this.ctx.restore()},getData:function(){this.data.rows=[];this.element.getElement("thead").getChildren()[0].getChildren().each(function(g){this.data.colNames.push(g.get("html"));this.data.rows.push([])}.bind(this));var d="";if(this.element.getElement("tfoot")){this.element.getElement("tfoot").getChildren()[0].getChildren().each(function(h){var g=h.get("html");this.data.rowNames.push(g);if(this.ctx.measureText(g).width>d.length){d=String(g)}}.bind(this))}this.element.getElement("tbody").getChildren().each(function(g){g.getChildren().each(function(i,h){var j=Number(i.get("html"));if(!typeOf(j)){j=i.get("html").toFloat()}this.data.rows[h].push(j);if(j>this.maxY){this.maxY=j}if(j<this.minY){this.minY=j}}.bind(this))}.bind(this));if(!this.element.getElement("tfoot")){for(var f=1;f<=this.element.getElement("tbody").getChildren().length;f++){var e=this.options.rowPrefix+f;this.data.rowNames.push(e);if(this.ctx.measureText(e).width>d.length){d=String(e)}}}this.longestRowName=d},draw:function(){var e=new a(this.bounds[0].x,this.bounds[1].y);var g=this.rowWidth/2;var d=0;var h=0;var i=(this.minY>=0)?this.bounds[1].y+(this.minY*this.ratio):this.bounds[1].y-Math.floor((this.chartHeight/(this.chartLines-1)));var f=0;this.data.rows.each(function(m,k){var l;if(this.options.showLines){l=new a(e.x,e.y);this.ctx.lineWidth=this.options.lineWeight;this.ctx.beginPath();this.ctx.strokeStyle=this.colors[k];this.ctx.moveTo(l.x+g,i-(m[0]*this.ratio));m.each(function(p){var o=l.x+g;var n=new a(o,i-(p*this.ratio));this.ctx.lineTo(n.x,n.y);l.x+=this.rowWidth}.bind(this));this.ctx.stroke()}if(this.options.showTicks){l=new a(e.x,e.y);f=(f>Object.getLength(c.Shapes)-1)?0:f;var j=this.shapes[f];m.each(function(p){var o=l.x+g;var n=new a(o,i-(p*this.ratio));j(this.ctx,n.x,n.y,this.options.tickSize,this.colors[k]);l.x+=this.rowWidth}.bind(this));f++}h++;d++}.bind(this));this.__drawRowLabels()},drawKey:function(){var f=Math.ceil(this.height*0.05);var g=this.data.colNames.length*f;var d=(this.height-g)/2;var e=0;this.data.colNames.each(function(j,i){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";this.ctx.fillText(c.escape(j),this.keyBounds[0].x+30,d+5);this.ctx.fillStyle=this.colors[i%this.colors.length];this.ctx.strokeStyle=this.colors[i%this.colors.length];this.ctx.lineWidth=3;if(this.options.showLines){this.ctx.beginPath();this.ctx.moveTo(this.keyBounds[0].x,d+0.5);this.ctx.lineTo(this.keyBounds[0].x+20,d+0.5);this.ctx.closePath();this.ctx.stroke()}if(this.options.showTicks){e=(e>Object.getLength(c.Shapes)-1)?0:e;var h=this.shapes[e];h(this.ctx,this.keyBounds[0].x+10,d,10,this.colors[i%this.colors.length]);e++}d+=f}.bind(this))},__drawRowLabels:function(){var d=new a(this.bounds[0].x,this.bounds[1].y);var e=(this.ctx.measureText(this.longestRowName).width>this.rowWidth);var f=Math.floor((this.data.rowNames.length*this.options.fontSize)/(this.chartWidth/2));this.ctx.fillStyle=this.options.fontColor;this.ctx.lineWidth=1;this.ctx.textAlign="center";this.data.rowNames.each(function(h,g){var i=c.escape(this.data.rowNames[g]);if(e){this.ctx.save();this.ctx.textAlign="right";this.ctx.translate(d.x+(this.rowWidth/2)+this.options.fontSize,this.bounds[1].y+4);this.ctx.rotate(-1.57079633);if(this.data.rowNames.length*this.options.fontSize>this.chartWidth){if(g%f==1){this.ctx.fillText(i,0,0)}}else{this.ctx.fillText(i,0,0)}this.ctx.restore()}else{this.ctx.fillText(i,d.x+(this.rowWidth/2),this.bounds[1].y+(this.rowPadding/2))}d.x+=this.rowWidth}.bind(this))}});c.Scatter=new Class({Extends:c.Line,options:{showTicks:true,showLines:false},initialize:function(e,d){this.parent(e,d)}});c.Pie=new Class({Extends:c.Base,options:{stroke:true,strokeWeight:3,strokeColor:"#ffffff",chartTextColor:"#000000",shadow:false,chartLineWeight:2,pieBorder:false},initialize:function(e,d){this.parent(e,d);if(this.element.get("tag")=="table"){this.rowCount=this.element.getElement("thead").getChildren()[0].getChildren().length;this.colors=this.__getColors(this.options.colors);this.options.showRowNames=false;this.getData();this.render()}},swapAxes:function(){return true},render:function(){this.ctx.save();this.prepareCanvas();this.radius=(this.chartHeight/2);if(this.options.showKey){this.drawKey()}this.draw();this.ctx.restore()},setData:function(g){this.bounds=[new a(),new a(this.width,this.height)];this.colors=this.__getColors(this.options.colors);g.rowNames=g.colNames;var d="";g.rowNames.each(function(h){if(this.ctx.measureText(h).width>this.ctx.measureText(d).width){d=String(h)}},this);this.longestRowName=d;var f=[];var e=0;g.rows.each(function(h){e+=h[0]});g.rows.each(function(j,h){var i=[j[0],(j[0]/e)*360];f.push(i)},this);this.pieTotal=e;g.rows=f;this.data=g},getData:function(){this.element.getElement("thead").getChildren()[0].getChildren().each(function(e){this.data.rowNames.push(e.get("html"));this.data.colNames.push(e.get("html"))}.bind(this));var d=0;this.element.getElement("tbody").getChildren()[0].getChildren().each(function(f){var e=[];var g=f.get("html").toInt();e.push(g);d+=g;this.data.rows.push(e)}.bind(this));this.data.rows.each(function(e){e.push((e[0]/d)*360)});this.pieTotal=d},draw:function(){var f=0;var d=new a((this.bounds[1].x/2)+this.options.padding,(this.bounds[1].y/2)+this.options.padding);if(this.options.shadow){var e=this.ctx.createRadialGradient(d.x,d.y,this.radius,d.x*1.03,d.y*1.03,this.radius*1.05);e.addColorStop(0.5,"#000000");e.addColorStop(0.75,"#000000");e.addColorStop(1,"rgba(0,0,0,0)");this.ctx.fillStyle=e;this.ctx.fillRect(this.bounds[0].x,this.bounds[0].y,this.width,this.height)}this.data.rows.each(function(o,j){this.ctx.fillStyle=this.colors[j%this.colors.length];this.ctx.beginPath();this.ctx.arc(d.x,d.y,this.radius,(Math.PI/180)*f,(Math.PI/180)*(o[1]+f),false);this.ctx.lineTo(d.x,d.y);this.ctx.closePath();this.ctx.fill();if(this.options.stroke){this.ctx.strokeStyle=this.options.strokeColor;this.ctx.lineWidth=this.options.strokeWeight;this.ctx.lineJoin="round";this.ctx.beginPath();this.ctx.arc(d.x,d.y,this.radius,(Math.PI/180)*f,(Math.PI/180)*(o[1]+f),false);this.ctx.lineTo(d.x,d.y);this.ctx.closePath();this.ctx.stroke()}if(this.options.showValues){this.ctx.font=this.options.fontSize+"px "+this.options.font;this.ctx.fillStyle=this.options.chartTextColor;this.ctx.textAlign="center";var g=(Math.PI/180)*(f);var i=(Math.PI/180)*(o[1]+f);var h=g+((i-g)/2);var k=Math.round((o[0]/this.pieTotal)*100);var l=(k<5)?0.9:1.75;var n=this.radius*Math.cos(h)/l;var m=this.radius*Math.sin(h)/l;this.ctx.fillText(k+"%",d.x+n,d.y+m)}f+=o[1]}.bind(this));if(this.options.pieBorder){this.ctx.lineWidth=this.options.chartLineWeight;this.ctx.strokeStyle=this.options.chartLineColor;this.ctx.beginPath();this.ctx.arc(d.x,d.y,this.radius-1,0,Math.PI*2);this.ctx.stroke()}},drawKey:function(){var e=Math.ceil(this.height*0.06);var f=this.data.rowNames.length*e;f=(f>this.height)?this.height*0.9:f;var d=(this.height-f)/2;this.ctx.font=this.options.fontSize+"px "+this.options.font;this.data.rowNames.each(function(h,g){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";this.ctx.fillText(c.escape(h),this.keyBounds[0].x+14,d+8);this.ctx.fillStyle=this.colors[g%this.colors.length];this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(d),10,10);d+=e}.bind(this))}});c.Doughnut=new Class({Extends:c.Base,options:{stroke:true,strokeWeight:1,strokeColor:"#ffffff",chartTextColor:"#000000",shadow:false,chartLineWeight:2,pieBorder:false},initialize:function(e,d){this.parent(e,d);if(this.element.get("tag")=="table"){this.getData();this.rowCount=this.element.getElements("th").length;this.colors=this.__getColors(this.options.colors);this.options.showRowNames=false;this.render()}},swapAxes1:function(){return true},render:function(){this.ctx.save();this.prepareCanvas();this.radius=(this.chartHeight/2);if(this.options.showKey){this.drawKey()}this.draw();this.ctx.restore()},setData:function(f){this.bounds=[new a(),new a(this.width,this.height)];this.colors=this.__getColors(this.options.colors);var d="";f.colNames.each(function(g){if(this.ctx.measureText(g).width>this.ctx.measureText(d).width){d=String(g)}},this);this.longestRowName=d;var e=[];f.totals=[];f.rows.each(function(j,g){var h=0;j.each(function(k){h+=(typeof(k)=="number")?k:k[0]});var i=[];j.each(function(k){var l=(typeof(k)=="number")?k:k[0];i.push([l,(l/h)*360])});e.push(i);f.totals.push(h)});f.rows=e;this.data=f},getData:function(){this.element.getElements("th").each(function(e){this.data.colNames.push(e.get("html"))}.bind(this));var d=this.element.getElements("tbody tr");if(this.element.tfoot){this.element.getElement("tfoot").getChildren().getChildren().each(function(e){this.data.rowNames.push(e.get("html"))}.bind(this))}else{d.each(function(f,e){this.data.rowNames.push(this.options.rowPrefix+e)},this)}this.data.totals=[];d.each(function(h,e){var f=0;h.getElements("td").each(function(i){f+=i.get("html").toInt()});var g=[];h.getElements("td").each(function(i){g.push([i.get("html").toInt(),(i.get("html").toInt()/f)*360])});this.data.rows.push(g);this.data.totals.push(f)},this)},draw:function(){var g=0;var e=new a((this.bounds[1].x/2)+this.options.padding,(this.bounds[1].y/2)+this.options.padding);var f=(this.radius/2)/this.data.rows.length;var d=Number(this.radius);this.data.rows.each(function(i,h){i.each(function(j,k){this.ctx.fillStyle=this.colors[k%this.colors.length];this.ctx.beginPath();this.ctx.arc(e.x,e.y,d,(Math.PI/180)*g,(Math.PI/180)*(j[1]+g),false);this.ctx.lineTo(e.x,e.y);this.ctx.closePath();this.ctx.fill();if(this.options.stroke){this.ctx.strokeStyle=this.options.strokeColor;this.ctx.lineWidth=this.options.strokeWeight;this.ctx.beginPath();this.ctx.arc(e.x,e.y,d,(Math.PI/180)*g,(Math.PI/180)*(j[1]+g),false);this.ctx.lineTo(e.x,e.y);this.ctx.closePath();this.ctx.stroke()}g+=j[1]},this);d-=f;g=0},this);this.ctx.beginPath();this.ctx.fillStyle="#ffffff";this.ctx.arc(e.x,e.y,this.radius/2,0,Math.PI*2);this.ctx.fill()},drawKey:function(){var e=Math.ceil(this.height*0.06);var f=this.data.rowNames.length*e;f=(f>this.height)?this.height*0.9:f;var d=(this.height-f)/2;this.ctx.font=this.options.fontSize+"px "+this.options.font;this.data.colNames.each(function(h,g){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";this.ctx.fillText(c.escape(h),this.keyBounds[0].x+14,d+8);this.ctx.fillStyle=this.colors[g%this.colors.length];this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(d),10,10);d+=e}.bind(this))}});c.Shapes={square:function(e,d,h,g,f){e.fillStyle=f;e.fillRect(d-(g/2),h-(g/2),g,g)},circle:function(e,d,h,g,f){e.fillStyle=f;e.beginPath();e.arc(d,h,g/2,0,(Math.PI/180)*360,true);e.closePath();e.fill()},triangle:function(e,d,i,h,g){e.fillStyle=g;e.beginPath();d-=h/2;i-=h/2;var f=new a(d+h,i+h);e.moveTo(d,f.y);e.lineTo(d+(h/2),i);e.lineTo(f.x,f.y);e.closePath();e.fill()},cross:function(e,d,h,g,f){d-=g/2;h-=g/2;e.strokeStyle=f;e.lineWidth=g/2;e.beginPath();e.moveTo(d,h);e.lineTo(d+g,h+g);e.moveTo(d,h+g);e.lineTo(d+g,h);e.closePath();e.stroke()},diamond:function(e,d,h,g,f){d-=g/2;h-=g/2;e.fillStyle=f;e.beginPath();e.moveTo(d+(g/2),h);e.lineTo(d+g,h+(g/2));e.lineTo(d+(g/2),h+g);e.lineTo(d,h+(g/2));e.closePath();e.fill()},pipe:function(e,d,h,g,f){h-=g/2;e.strokeStyle=f;e.lineWidth=g/2;e.beginPath();e.moveTo(d,h);e.lineTo(d,h+g);e.stroke()}};c.escape=function(e){e=String(e);var d=[[/\&amp;/g,"&"],[/\&lt;/g,"<"],[/\&gt;/g,">"]];d.each(function(f){e=e.replace(f[0],f[1])});return e}})(window);