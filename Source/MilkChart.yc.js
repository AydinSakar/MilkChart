// Copyright 2006 Google Inc.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

/*
---
description: Graphing/chart tool for mootools 1.2

license: Apache License, Version 2.0

authors:
- Brett Dixon

requires: 
  core

provides: [MilkChart.Column, MilkChart.Bar, MilkChart.Line, MilkChart.Scatter, MilkChart.Pie]

...
*/
var MilkChart;var Point=new Class({initialize:function(a,b){this.x=a||0;this.y=b||0}});MilkChart=new Class({Implements:[Options,Events],options:{width:480,height:290,colors:["#4f81bd","#c0504d","#9bbb59","#8064a2","#4198af","#db843d"],padding:12,font:"Verdana",fontColor:"#000000",fontSize:10,background:"#FFFFFF",chartLineColor:"#878787",chartLineWeight:1,border:true,borderWeight:1,borderColor:"#878787",titleSize:18,titleFont:"Verdana",titleColor:"#000000",showRowNames:true,showValues:true,showKey:true,useZero:true,copy:false,data:{},onFail:$empty},initialize:function(b,a){this.setOptions(a);this.element=document.id(b);if(Browser.Engine.trident){this.fireEvent("onFail",[this.element]);return false}this.width=this.options.width;this.height=this.options.height;this.container=new Element("div").inject(this.element.getParent());this.container.setStyles({width:this.width,height:this.height});this._canvas=new Element("canvas",{width:this.options.width,height:this.options.height}).inject(this.container);this.ctx=this._canvas.getContext("2d");this.colNames=[];this.rowNames=[];this.rowCount=this.element.getElement("thead").getChildren()[0].getChildren().length;this.minY=(this.options.useZero)?0:10000000000;this.maxY=0;this.rows=[];this.options.title=false||this.element.title;this.bounds=[new Point(),new Point(this.width,this.height)];this.chartWidth=0;this.chartHeight=0;this.keyPadding=this.width*0.2;this.rowPadding=this.height*0.1;this.colors=this.__getColors(this.options.colors);this.shapes=[];MilkChart.Shapes.each(function(c){this.shapes.push(c)}.bind(this))},prepareCanvas:function(){if(!this.options.copy){this.element.setStyle("display","none")}this.ctx.fillStyle=this.options.background;this.ctx.fillRect(0,0,this.width,this.height);if(this.options.border){this.ctx.lineWeight=this.options.borderWeight;this.ctx.strokeRect(0.5,0.5,this.width-1,this.height-1)}if(this.options.showValues){charPadding=0.03;this.valueColumnWidth=(this.bounds[1].x-this.bounds[0].x)*(String(this.maxY).length*charPadding);this.bounds[0].x+=this.valueColumnWidth}this.bounds[0].x+=this.options.padding;this.bounds[0].y+=this.options.padding;this.bounds[1].x-=this.options.padding*2;this.bounds[1].y-=this.options.padding*2;if(this.options.showRowNames){this.bounds[1].y-=this.rowPadding}else{this.rowPadding=0}if(this.options.showKey){this.bounds[1].x-=this.keyPadding;this.keyBounds=[new Point(this.bounds[1].x*1.02,this.bounds[0].y),new Point(this.bounds[1].x*0.5,this.bounds[1].y)]}if(this.options.title){titleHeight=this.bounds[0].y+this.height*0.1;this.bounds[0].y=titleHeight;this.titleBounds=[new Point(this.bounds[0].x,0),new Point(this.bounds[1].x,titleHeight)];this.drawTitle()}this.chartWidth=this.bounds[1].x-this.bounds[0].x;this.chartHeight=this.bounds[1].y-this.bounds[0].y},drawTitle:function(){var a=1.25;var b=this.options.titleSize*a;this.ctx.textAlign="center";this.ctx.font=this.options.titleSize+"px "+this.options.titleFont;this.ctx.fillStyle=this.options.titleColor;this.ctx.fillText(this.options.title,this.bounds[0].x+(this.bounds[1].x-this.bounds[0].x)/2,b,this.chartWidth)},drawAxes:function(){this.ctx.beginPath();this.ctx.strokeStyle=this.options.chartLineColor;this.ctx.moveTo(this.bounds[0].x+0.5,this.bounds[0].y+0.5);this.ctx.lineTo(this.bounds[0].x+0.5,this.bounds[1].y+0.5);this.ctx.moveTo(this.bounds[0].x+0.5,this.bounds[1].y+0.5);this.ctx.lineTo(this.bounds[1].x+0.5,this.bounds[1].y+0.5);this.ctx.stroke()},drawValueLines:function(){var f=[1,2,5,10,20,50,100,150,500,1000,1500,2500,5000,10000];var g=9;var e=0;this.chartLines=1;delta=Math.floor((this.maxY-this.minY));while(Math.floor((delta/f[e]))>g){e++}this.chartLines=Math.floor((delta/f[e]))+2;var d=f[e];var c=(this.minY<0)?(d+this.minY):0;this.ratio=(this.chartHeight)/(((this.chartLines-1)*d)+(d/3));this.ctx.font=this.options.fontSize+"px "+this.options.font;this.ctx.textAlign="right";this.ctx.fillStyle=this.options.fontColor;var k=this.bounds[1].y-this.bounds[0].y;var h=Math.floor(k/(this.chartLines-1));for(e=0;e<this.chartLines;e++){this.ctx.fillStyle=this.options.fontColor;var a=this.bounds[1].y-(e*h);var b=(this.chartLines*d)-((this.chartLines-e)*d)+this.minY-c;this.ctx.beginPath();a+=0.5;this.ctx.moveTo(this.bounds[0].x-4,a);if(this.options.showValues){this.ctx.fillText(String(b),this.bounds[0].x-8,a+3)}this.ctx.lineTo(this.bounds[1].x,a);this.ctx.stroke()}},getData:function(){return null},draw:function(){return null},drawKey:function(){return null},__getColors:function(c){var b=[];if(c.length==1||c.length==2){var d=new Color(c[0]);var a=(c.length==2)?new Color(c[1]):new Color("#ffffff").mix(c[0],20);var h=[(a[0]-d[0])/this.rowCount,(a[1]-d[1])/this.rowCount,(a[2]-d[2])/this.rowCount];var g=d;for(i=0;i<this.rowCount;i++){b.push(g.rgbToHex());for(j=0;j<h.length;j++){g[j]+=parseInt(h[j])}}}else{var e=0;var f=c.slice(0);while(b.length!=this.rowCount){if(f.length==0){f=c.slice(0);e+=20}newColor=new Color(f.shift()).mix("#ffffff",e);b.push(newColor.rgbToHex())}}return b}});MilkChart.Column=new Class({Extends:MilkChart,options:{columnBorder:false,columnBorderWeight:2,columnBorderColor:"#ffffff"},initialize:function(b,a){this.parent(b,a);this.getData();this.prepareCanvas();this.rowWidth=Math.round(this.chartWidth/this.rows.length);this.drawAxes();this.drawValueLines();this.draw();if(this.options.showKey){this.drawKey()}},getData:function(){this.element.getElement("thead").getChildren()[0].getChildren().each(function(a){this.colNames.push(a.get("html"))}.bind(this));if(this.element.getElement("tfoot")){this.element.getElement("tfoot").getChildren()[0].getChildren().each(function(a){this.rowNames.push(a.get("html"))}.bind(this))}this.element.getElement("tbody").getChildren().each(function(b){var a=[];b.getChildren().each(function(c){val=Number(c.get("html"));if(!$type(val)){val=c.get("html").toFloat()}a.push(val);if(val>this.maxY){this.maxY=val}if(val<this.minY){this.minY=val}}.bind(this));this.rows.push(a)}.bind(this));if(!this.element.getElement("tfoot")){for(i=1;i<=this.rows.length;i++){this.rowNames.push("Row "+i)}}},draw:function(){var e=(this.minY>=0)?this.bounds[1].y:this.bounds[1].y-Math.floor((this.chartHeight/(this.chartLines-1)));var c=new Point(this.bounds[0].x,e);var a=Math.floor(this.rowWidth*0.16);var d=Math.ceil((this.rowWidth-(a*2))/this.rows[0].length);var b=0;this.rows.each(function(k){var g=new Point(c.x,c.y);var f=0;this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="center";if(this.options.showRowNames){var h=MilkChart.escape(this.rowNames[b]);this.ctx.fillText(h,g.x+(this.rowWidth/2),this.bounds[1].y+(this.rowPadding/2))}k.each(function(m){this.ctx.beginPath();this.ctx.fillStyle=this.colors[f];var l=Math.ceil(m*this.ratio);this.ctx.fillStyle=this.colors[f];this.ctx.fillRect(g.x+a,g.y-l,d,l);if(this.options.columnBorder){this.ctx.strokeStyle=this.options.columnBorderColor;this.ctx.lineWidth=this.options.columnBorderWeight;this.ctx.strokeRect(g.x+a,g.y-l,d,l)}g.x+=d;f++}.bind(this));c.x+=this.rowWidth;b++}.bind(this))},drawKey:function(){var e=0;var b=14;var c=Math.ceil(this.height*0.05);var d=this.colNames.length*c;var a=(this.height-d)/2;this.colNames.each(function(f){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";f=MilkChart.escape(f);this.ctx.fillText(f,this.keyBounds[0].x+b,a+8);this.ctx.fillStyle=this.colors[e];this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(a),10,10);e++;a+=c},this)}});MilkChart.Bar=new Class({Extends:MilkChart.Column,options:{},initialize:function(b,a){this.parent(b,a)},drawValueLines:function(){var f=[1,2,5,10,20,50,100,150,500,1000];var g=9;var e=0;this.chartLines=1;delta=Math.floor((this.maxY-this.minY));while(Math.floor((delta/f[e]))>g){e++}this.chartLines=Math.floor((delta/f[e]))+2;var d=f[e];var c=(this.minY<0)?(d+this.minY):0;this.ratio=(this.chartWidth)/(((this.chartLines-1)*d));this.ctx.font=this.options.fontSize+"px "+this.options.font;this.ctx.textAlign="center";this.ctx.fillStyle=this.options.fontColor;var k=this.bounds[1].y-this.bounds[0].y;var h=Math.ceil(this.chartWidth/(this.chartLines-1));for(e=0;e<this.chartLines;e++){this.ctx.fillStyle=this.options.fontColor;var a=this.bounds[0].x+(e*h);var b=(this.chartLines*d)-((this.chartLines-e)*d)+this.minY;this.ctx.beginPath();var a=Math.round(a)+0.5;this.ctx.moveTo(a,this.bounds[0].y);this.ctx.fillText(MilkChart.escape(b),a,this.bounds[1].y+14);this.ctx.lineTo(a,this.bounds[1].y+4);this.ctx.stroke()}},draw:function(){var c=new Point(this.bounds[0].x,this.bounds[1].y);this.colHeight=Math.round(this.chartHeight/this.rows.length);var e=0.16;var a=Math.ceil(this.colHeight*e);var d=Math.ceil((this.colHeight-(a*2))/this.rows[0].length);var b=0;this.rows.each(function(k){var g=new Point(c.x,c.y);var f=0;this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="center";var h=Math.ceil(this.ctx.measureText(this.rowNames[b]).width);this.ctx.fillText(MilkChart.escape(this.rowNames[b]),g.x-((d+h)/2),g.y-(this.rowPadding/2));k.each(function(m){this.ctx.beginPath();this.ctx.fillStyle=this.colors[f];var l=Math.ceil(m*this.ratio);this.ctx.fillRect(g.x,g.y-a,l,d);g.y-=d;f++}.bind(this));c.y-=this.colHeight;b++}.bind(this))}});MilkChart.Line=new Class({Extends:MilkChart,options:{showTicks:false,showLines:true,lineWeight:3},initialize:function(b,a){this.parent(b,a);this.getData();this.prepareCanvas();this.rowWidth=this.chartWidth/this.rows[0].length;this.drawAxes();this.drawValueLines();this.draw();if(this.options.showKey){this.drawKey()}},getData:function(){this.rows=[];this.element.getElement("thead").getChildren()[0].getChildren().each(function(a){this.colNames.push(a.get("html"));this.rows.push([])}.bind(this));if(this.element.getElement("tfoot")){this.element.getElement("tfoot").getChildren()[0].getChildren().each(function(a){this.rowNames.push(a.get("html"))}.bind(this))}this.element.getElement("tbody").getChildren().each(function(a){a.getChildren().each(function(c,b){d=Number(c.get("html"));if(!$type(d)){var d=c.get("html").toFloat()}this.rows[b].push(d);if(d>this.maxY){this.maxY=d}if(d<this.minY){this.minY=d}}.bind(this))}.bind(this));if(!this.element.getElement("tfoot")){for(i=1;i<=this.element.getElement("tbody").getChildren().length;i++){this.rowNames.push("Row "+i)}}},draw:function(){var b=new Point(this.bounds[0].x,this.bounds[1].y);var c=this.rowWidth/2;var a=0;var d=0;var e=(this.minY>=0)?this.bounds[1].y+(this.minY*this.ratio):this.bounds[1].y-Math.floor((this.chartHeight/(this.chartLines-1)));shapeIndex=0;this.rows.each(function(l,g){if(this.options.showLines){var k=new Point(b.x,b.y);var h=this.bounds[0].x+c;this.ctx.lineWidth=this.options.lineWeight;this.ctx.beginPath();this.ctx.strokeStyle=this.colors[d];this.ctx.moveTo(k.x+c,e-(l[0]*this.ratio));l.each(function(o){var n=k.x+c;var m=new Point(n,e-(o*this.ratio));this.ctx.lineTo(m.x,m.y);k.x+=this.rowWidth}.bind(this));this.ctx.stroke()}if(this.options.showTicks){var k=new Point(b.x,b.y);var h=this.bounds[0].x+c;var f=this.shapes[shapeIndex];l.each(function(o){var n=k.x+c;var m=new Point(n,e-(o*this.ratio));f(this.ctx,m.x,m.y,10,this.colors[d]);k.x+=this.rowWidth}.bind(this));shapeIndex++}d++;a++}.bind(this));this.__drawRowLabels()},drawKey:function(){var b=Math.ceil(this.height*0.05);var c=this.colNames.length*b;var a=(this.height-c)/2;this.colNames.each(function(f,e){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";this.ctx.fillText(MilkChart.escape(f),this.keyBounds[0].x+30,a+5);this.ctx.fillStyle=this.colors[e];this.ctx.strokeStyle=this.colors[e];this.ctx.lineWidth=3;if(this.options.showLines){this.ctx.beginPath();this.ctx.moveTo(this.keyBounds[0].x,a+0.5);this.ctx.lineTo(this.keyBounds[0].x+20,a+0.5);this.ctx.closePath();this.ctx.stroke()}if(this.options.showTicks){var d=this.shapes[e];d(this.ctx,this.keyBounds[0].x+10,a,10,this.colors[e])}a+=b}.bind(this))},__drawRowLabels:function(){var a=new Point(this.bounds[0].x,this.bounds[1].y);var b=this.rowWidth/2;this.ctx.fillStyle=this.options.fontColor;this.ctx.lineWidth=1;this.ctx.textAlign="center";this.rowNames.each(function(d,c){this.ctx.fillText(MilkChart.escape(this.rowNames[c]),a.x+b,this.bounds[1].y+(this.rowPadding/2));a.x+=this.rowWidth}.bind(this))}});MilkChart.Scatter=new Class({Extends:MilkChart.Line,options:{showTicks:true,showLines:false},initialize:function(b,a){this.parent(b,a)}});MilkChart.Pie=new Class({Extends:MilkChart,options:{stroke:true,strokeWeight:3,strokeColor:"#ffffff",chartTextColor:"#000000",shadow:false,chartLineWeight:2,pieBorder:false},initialize:function(b,a){this.parent(b,a);this.rowCount=this.element.getElement("thead").getChildren()[0].getChildren().length;this.colors=this.__getColors(this.options.colors);this.options.showRowNames=false;this.getData();this.prepareCanvas();this.radius=(this.chartHeight/2);if(this.options.showKey){this.drawKey()}this.draw()},getData:function(){this.element.getElement("thead").getChildren()[0].getChildren().each(function(b){this.rowNames.push(b.get("html"))}.bind(this));var a=0;this.element.getElement("tbody").getChildren()[0].getChildren().each(function(c){var b=[];var d=c.get("html").toInt();b.push(d);a+=d;this.rows.push(b)}.bind(this));this.rows.each(function(b){b.push((b[0]/a)*360)})},draw:function(){var c=0;var a=new Point((this.bounds[1].x/2)+this.options.padding,(this.bounds[1].y/2)+this.options.padding);if(this.options.shadow){var b=this.ctx.createRadialGradient(a.x,a.y,this.radius,a.x*1.03,a.y*1.03,this.radius*1.05);b.addColorStop(0.5,"#000000");b.addColorStop(0.75,"#000000");b.addColorStop(1,"rgba(0,0,0,0)");this.ctx.fillStyle=b;this.ctx.fillRect(this.bounds[0].x,this.bounds[0].y,this.width,this.height)}this.rows.each(function(n,g){this.ctx.fillStyle=this.colors[g];this.ctx.beginPath();this.ctx.arc(a.x,a.y,this.radius,(Math.PI/180)*c,(Math.PI/180)*(n[1]+c),false);this.ctx.lineTo(a.x,a.y);this.ctx.closePath();this.ctx.fill();if(this.options.stroke){this.ctx.strokeStyle=this.options.strokeColor;this.ctx.lineWidth=this.options.strokeWeight;this.ctx.lineJoin="round";this.ctx.beginPath();this.ctx.arc(a.x,a.y,this.radius,(Math.PI/180)*c,(Math.PI/180)*(n[1]+c),false);this.ctx.lineTo(a.x,a.y);this.ctx.closePath();this.ctx.stroke()}if(this.options.showValues){this.ctx.font=this.options.fontSize+"px "+this.options.font;this.ctx.fillStyle=this.options.chartTextColor;this.ctx.textAlign="center";var d=(Math.PI/180)*(c);var f=(Math.PI/180)*(n[1]+c);var e=d+((f-d)/2);var h=Math.round((n[0]/pieTotal)*100);var k=(h<5)?0.9:1.75;var m=this.radius*Math.cos(e)/k;var l=this.radius*Math.sin(e)/k;this.ctx.fillText(h+"%",a.x+m,a.y+l)}c+=n[1]}.bind(this));if(this.options.pieBorder){this.ctx.lineWidth=this.options.chartLineWeight;this.ctx.strokeStyle=this.options.chartLineColor;this.ctx.beginPath();this.ctx.arc(a.x,a.y,this.radius-1,0,Math.PI*2);this.ctx.stroke()}},drawKey:function(){var d=0;var b=Math.ceil(this.height*0.05);var c=this.rowNames.length*b;var c=(c>this.height)?this.height*0.9:c;var a=(this.height-c)/2;this.ctx.font=this.options.fontSize+"px "+this.options.font;this.rowNames.each(function(e){this.ctx.fillStyle=this.options.fontColor;this.ctx.textAlign="left";this.ctx.fillText(MilkChart.escape(e),this.keyBounds[0].x+14,a+8);this.ctx.fillStyle=this.colors[d];this.ctx.fillRect(Math.ceil(this.keyBounds[0].x),Math.ceil(a),10,10);d++;a+=b}.bind(this))}});MilkChart.Shapes=new Hash({square:function(b,a,e,d,c){b.fillStyle=c;b.fillRect(a-(d/2),e-(d/2),d,d)},circle:function(b,a,e,d,c){b.fillStyle=c;b.beginPath();b.arc(a,e,d/2,0,(Math.PI/180)*360,true);b.closePath();b.fill()},triangle:function(b,a,e,d,c){b.fillStyle=c;b.beginPath();a-=d/2;e-=d/2;lr=new Point(a+d,e+d);b.moveTo(a,lr.y);b.lineTo(a+(d/2),e);b.lineTo(lr.x,lr.y);b.closePath();b.fill()},cross:function(b,a,e,d,c){a-=d/2;e-=d/2;b.strokeStyle=c;b.lineWidth=1;b.beginPath();b.moveTo(a,e);b.lineTo(a+d,e+d);b.moveTo(a,e+d);b.lineTo(a+d,e);b.closePath();b.stroke()},diamond:function(b,a,e,d,c){a-=d/2;e-=d/2;b.fillStyle=c;b.beginPath();b.moveTo(a+(d/2),e);b.lineTo(a+d,e+(d/2));b.lineTo(a+(d/2),e+d);b.lineTo(a,e+(d/2));b.closePath();b.fill()}});MilkChart.escape=function(b){b=String(b);var a=[[/\&amp;/g,"&"],[/\&lt;/g,"<"],[/\&gt;/g,">"]];a.each(function(c){b=b.replace(c[0],c[1])});return b};